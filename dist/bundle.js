(()=>{"use strict";function e(e,t,r){const n=e.createShader(t);if(e.shaderSource(n,r),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS)){const t=e.getShaderInfoLog(n);throw e.deleteShader(n),new Error("Shader compile error: "+t+"\n"+r)}return n}function t(t,r,n,a={}){const o=e(t,t.VERTEX_SHADER,r),i=e(t,t.FRAGMENT_SHADER,n),c=t.createProgram();t.attachShader(c,o),t.attachShader(c,i);for(const[e,r]of Object.entries(a))t.bindAttribLocation(c,r,e);if(t.linkProgram(c),!t.getProgramParameter(c,t.LINK_STATUS)){const e=t.getProgramInfoLog(c);throw t.deleteProgram(c),new Error("Program link error: "+e)}return c}function r(e,t,r){const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,r,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindTexture(e.TEXTURE_2D,null),n}function n(e,t){const r=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,r),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0);const n=e.checkFramebufferStatus(e.FRAMEBUFFER)===e.FRAMEBUFFER_COMPLETE;if(e.bindFramebuffer(e.FRAMEBUFFER,null),!n)throw new Error("Framebuffer incomplete");return r}const a="attribute vec2 a_pos;\nvarying vec2 v_uv;\nvoid main(){ v_uv = a_pos*0.5 + 0.5; gl_Position = vec4(a_pos,0.0,1.0); }\n",o={perspective(e,t,r,n,a){const o=1/Math.tan(.5*t),i=1/(n-a);return e[0]=o/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(a+n)*i,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*a*n*i,e[15]=0,e},lookAt(e,t,r,n){let a=t[0]-r[0],o=t[1]-r[1],i=t[2]-r[2],c=1/Math.hypot(a,o,i);a*=c,o*=c,i*=c;let l=n[1]*i-n[2]*o,f=n[2]*a-n[0]*i,s=n[0]*o-n[1]*a;c=1/Math.hypot(l,f,s),l*=c,f*=c,s*=c;let u=o*s-i*f,d=i*l-a*s,m=a*f-o*l;return e[0]=l,e[1]=u,e[2]=a,e[3]=0,e[4]=f,e[5]=d,e[6]=o,e[7]=0,e[8]=s,e[9]=m,e[10]=i,e[11]=0,e[12]=-(l*t[0]+f*t[1]+s*t[2]),e[13]=-(u*t[0]+d*t[1]+m*t[2]),e[14]=-(a*t[0]+o*t[1]+i*t[2]),e[15]=1,e},multiply(e,t,r){const n=t[0],a=t[1],o=t[2],i=t[3],c=t[4],l=t[5],f=t[6],s=t[7],u=t[8],d=t[9],m=t[10],h=t[11],A=t[12],R=t[13],E=t[14],_=t[15],b=r[0],F=r[1],p=r[2],v=r[3],g=r[4],M=r[5],T=r[6],y=r[7],B=r[8],w=r[9],x=r[10],U=r[11],L=r[12],P=r[13],D=r[14],S=r[15];return e[0]=n*b+c*F+u*p+A*v,e[1]=a*b+l*F+d*p+R*v,e[2]=o*b+f*F+m*p+E*v,e[3]=i*b+s*F+h*p+_*v,e[4]=n*g+c*M+u*T+A*y,e[5]=a*g+l*M+d*T+R*y,e[6]=o*g+f*M+m*T+E*y,e[7]=i*g+s*M+h*T+_*y,e[8]=n*B+c*w+u*x+A*U,e[9]=a*B+l*w+d*x+R*U,e[10]=o*B+f*w+m*x+E*U,e[11]=i*B+s*w+h*x+_*U,e[12]=n*L+c*P+u*D+A*S,e[13]=a*L+l*P+d*D+R*S,e[14]=o*L+f*P+m*D+E*S,e[15]=i*L+s*P+h*D+_*S,e}},i=5e3,c=1/30,l=20,f={"Ambient (α+β)":{mix:[{type:"alpha",frac:.3,speed:2.2,life:3.5,size:26,bright:1.05,qScale:1},{type:"beta",frac:.7,speed:7,life:7,size:10,bright:.65,qScale:1}]},"Am-241 (α)":{mix:[{type:"alpha",frac:1,speed:2.1,life:3.8,size:28,bright:1.15,qScale:.8}]},"Po-210 (α)":{mix:[{type:"alpha",frac:1,speed:2,life:3.4,size:28,bright:1.2,qScale:.8}]},"Rn-222 (α)":{mix:[{type:"alpha",frac:1,speed:2,life:3.2,size:26,bright:1.1,qScale:.85}]},"Sr-90 (β−)":{mix:[{type:"beta",frac:1,speed:6.5,life:7.5,size:9,bright:.6,qScale:1.2}]},"Cs-137 (β−)":{mix:[{type:"beta",frac:1,speed:7.5,life:8,size:10,bright:.62,qScale:1.2}]},"Co-60 (β−)":{mix:[{type:"beta",frac:1,speed:5.5,life:6.8,size:9,bright:.6,qScale:1.1}]},"Th-232 chain (α+β)":{mix:[{type:"alpha",frac:.6,speed:2,life:3.5,size:27,bright:1.1,qScale:.85},{type:"beta",frac:.4,speed:6.8,life:7.5,size:10,bright:.62,qScale:1.15}]},"Cosmic Muons (μ)":{cosmic:!0}},s=document.createElement("canvas");document.getElementById("app").appendChild(s);const u=function(e){const t=e.getContext("webgl",{alpha:!1,antialias:!0,preserveDrawingBuffer:!1});if(!t)throw new Error("WebGL not supported");return t}(s),d=t(u,a,"precision highp float;\nvarying vec2 v_uv;\nuniform sampler2D u_tex;\nvoid main(){ gl_FragColor = texture2D(u_tex, v_uv); }\n"),m=t(u,a,"precision highp float;\nvarying vec2 v_uv;\nuniform sampler2D u_prev;\nuniform float u_decay;\nvoid main(){\n  vec4 col = texture2D(u_prev, v_uv);\n  gl_FragColor = vec4(col.rgb * u_decay, 1.0);\n}\n"),h=t(u,"precision highp float;\nattribute vec3 a_pos;\nattribute float a_size;\nattribute float a_brightness;\nattribute float a_type; // 0=beta,1=alpha\nuniform mat4 u_viewProj;\nvarying float v_bright;\nvarying float v_type;\nvoid main(){\n  v_bright = a_brightness;\n  v_type = a_type;\n  vec4 clip = u_viewProj * vec4(a_pos, 1.0);\n  gl_Position = clip;\n  float size = a_size / max(0.1, clip.w);\n  gl_PointSize = size;\n}\n","precision highp float;\nvarying float v_bright;\nvarying float v_type;\nvoid main(){\n  vec2 p = gl_PointCoord*2.0 - 1.0;\n  float r = length(p);\n  float disk = smoothstep(1.0, 0.6, r);\n  float core = mix(0.9, 1.3, v_type);\n  float glow = mix(0.6, 1.0, v_type);\n  vec3 col = vec3(1.0) * (v_bright*core);\n  float alpha = disk * glow;\n  gl_FragColor = vec4(col, alpha);\n}\n"),A=t(u,"attribute vec3 a_pos;\nuniform mat4 u_viewProj;\nvoid main(){ gl_Position = u_viewProj * vec4(a_pos, 1.0); }\n","precision highp float;\nuniform vec3 u_color;\nvoid main(){ gl_FragColor = vec4(u_color, 1.0); }\n"),R=u.createBuffer();u.bindBuffer(u.ARRAY_BUFFER,R),u.bufferData(u.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),u.STATIC_DRAW);const E=u.createBuffer(),_=u.createBuffer(),b=u.createBuffer(),F=u.createBuffer(),p=u.createBuffer(),v=[[-l,-l,-l],[l,-l,-l],[l,-l,-l],[l,-l,l],[l,-l,l],[-l,-l,l],[-l,-l,l],[-l,-l,-l],[-l,l,-l],[l,l,-l],[l,l,-l],[l,l,l],[l,l,l],[-l,l,l],[-l,l,l],[-l,l,-l],[-l,-l,-l],[-l,l,-l],[l,-l,-l],[l,l,-l],[l,-l,l],[l,l,l],[-l,-l,l],[-l,l,l]].flat();u.bindBuffer(u.ARRAY_BUFFER,p),u.bufferData(u.ARRAY_BUFFER,new Float32Array(v),u.STATIC_DRAW);let g,M,T,y,B=2,w=2;function x(){u.disable(u.BLEND),u.bindFramebuffer(u.FRAMEBUFFER,T),u.clearColor(0,0,0,1),u.clear(u.COLOR_BUFFER_BIT),u.bindFramebuffer(u.FRAMEBUFFER,y),u.clearColor(0,0,0,1),u.clear(u.COLOR_BUFFER_BIT),u.bindFramebuffer(u.FRAMEBUFFER,null)}function U(){const e=Math.min(2,window.devicePixelRatio||1),t=Math.max(2,Math.floor(window.innerWidth*e)),a=Math.max(2,Math.floor(window.innerHeight*e));t===B&&a===w||(B=t,w=a,s.width=t,s.height=a,s.style.width="100%",s.style.height="100%",u.viewport(0,0,t,a),function(e,t){g&&u.deleteTexture(g),M&&u.deleteTexture(M),T&&u.deleteFramebuffer(T),y&&u.deleteFramebuffer(y),g=r(u,e,t),M=r(u,e,t),T=n(u,g),y=n(u,M),x()}(t,a))}window.addEventListener("resize",U),U();let L=.6,P=.2,D=14,S=!1,I=0,C=0;function Y(){const e=[D*Math.cos(P)*Math.cos(L),D*Math.sin(P),D*Math.cos(P)*Math.sin(L)],t=new Float32Array(16),r=new Float32Array(16),n=new Float32Array(16);o.lookAt(t,e,[0,0,0],[0,1,0]);const a=60*Math.PI/180;return o.perspective(r,a,B/w,.1,400),o.multiply(n,r,t),n}s.addEventListener("mousedown",e=>{S=!0,I=e.clientX,C=e.clientY}),window.addEventListener("mouseup",()=>S=!1),window.addEventListener("mousemove",e=>{if(!S)return;const t=(e.clientX-I)/window.innerWidth,r=(e.clientY-C)/window.innerHeight;L+=3*t,P=Math.max(-1.2,Math.min(1.2,P+3*r)),I=e.clientX,C=e.clientY}),window.addEventListener("wheel",e=>{D=Math.max(4,Math.min(40,D+Math.sign(e.deltaY)))});const N=new Float32Array(6e4);let X=0;function O(e){const t=H.value,r=f[t]||f["Ambient (α+β)"];if(r.cosmic){const e=18,t=(2*Math.random()-1)*e,r=(2*Math.random()-1)*e,n=22,a=[.1*Math.random()-.05,-1,.1*Math.random()-.05],o=30,i=50;return void z(t,n,r,a[0]*o,a[1]*o,a[2]*o,i,0,8,.5,.05)}const n=function(e){const t=Math.random();let r=0;for(const n of e)if(r+=n.frac,t<=r)return n;return e[e.length-1]}(r.mix),a=function(){const e=2*Math.random()-1,t=Math.random()*Math.PI*2,r=Math.sqrt(Math.max(0,1-e*e));return[r*Math.cos(t),r*Math.sin(t),e]}(),o=n.speed*(.85+.3*Math.random()),i=n.life*(.9+.3*Math.random()),c="alpha"===n.type?1:0;z(e[0],e[1],e[2],a[0]*o,a[1]*o,a[2]*o,i,c,n.size,n.bright,n.qScale)}function z(e,t,r,n,a,o,c,l,f,s,u){let d=-1;for(let e=0;e<X;e++)if(0===N[12*e+10]){d=e;break}if(d<0){if(X>=i)return;d=X++}const m=12*d;N[m+0]=e,N[m+1]=t,N[m+2]=r,N[m+3]=n,N[m+4]=a,N[m+5]=o,N[m+6]=c,N[m+7]=l,N[m+8]=f,N[m+9]=s,N[m+10]=1,N[m+11]=u||1}s.addEventListener("click",e=>{O(function(e,t){const r=L,n=P,a=D,o=[a*Math.cos(n)*Math.cos(r),a*Math.sin(n),a*Math.cos(n)*Math.sin(r)],i=e/window.innerWidth*2-1,c=1-t/window.innerHeight*2,l=[-o[0],-o[1],-o[2]],f=Math.hypot(l[0],l[1],l[2]);l[0]/=f,l[1]/=f,l[2]/=f;let s=[l[2],0,-l[0]],u=Math.hypot(s[0],s[1],s[2]);s=[s[0]/u,s[1]/u,s[2]/u];let d=[s[1]*l[2]-s[2]*l[1],s[2]*l[0]-s[0]*l[2],s[0]*l[1]-s[1]*l[0]];const m=60*Math.PI/180,h=window.innerWidth/window.innerHeight,A=Math.tan(m/2),R=[l[0]+i*h*A*s[0]+c*A*d[0],l[1]+i*h*A*s[1]+c*A*d[1],l[2]+i*h*A*s[2]+c*A*d[2]],E=-o[1]/(R[1]||1e-6);return[o[0]+R[0]*E,0,o[2]+R[2]*E]}(e.clientX,e.clientY))});const q=document.getElementById("bRange"),W=document.getElementById("vRange"),k=document.getElementById("rRange"),G=document.getElementById("trailRange"),H=document.getElementById("isoSelect"),j=document.getElementById("toggleBtn"),V=document.getElementById("clearBtn"),K={};for(const e of H.options)K[e.value]=parseFloat(k.value);K["Cosmic Muons (μ)"]=5,H.addEventListener("change",()=>{k.value=K[H.value]||0}),k.addEventListener("input",()=>{K[H.value]=parseFloat(k.value)});let J=!1;j.addEventListener("click",()=>{J=!J,j.textContent=J?"Resume":"Pause"}),V.addEventListener("click",()=>{x()});let Q=new Float32Array(15e3),Z=new Float32Array(i),$=new Float32Array(i),ee=new Float32Array(i);function te(e){const t=u.getAttribLocation(e,"a_pos");u.bindBuffer(u.ARRAY_BUFFER,R),u.enableVertexAttribArray(t),u.vertexAttribPointer(t,2,u.FLOAT,!1,0,0)}let re=performance.now();requestAnimationFrame(function e(t){const r=Math.min(c,(t-re)/1e3);re=t,J||function(e){const t=parseFloat(q.value),r=parseFloat(W.value),n=parseFloat(k.value)*e;let a=Math.floor(n);Math.random()<n-a&&a++;const o=H.value;for(let e=0;e<a;e++)if("Cosmic Muons (μ)"===o)O(null);else{const e=18;O([(2*Math.random()-1)*e,(2*Math.random()-1)*e,(2*Math.random()-1)*e])}const i=.3+.8*r,c=.3+1.2*r;for(let n=0;n<X;n++){const a=12*n;if(0===N[a+10])continue;let o=N[a+0],f=N[a+1],s=N[a+2],u=N[a+3],d=N[a+4],m=N[a+5],h=N[a+6];const A=N[a+7],R=(A?.6:1)*(N[a+11]||1),E=[0,t,0],_=R*(d*E[2]-m*E[1]),b=R*(m*E[0]-u*E[2]),F=R*(u*E[1]-d*E[0]);u+=_*e,d+=b*e,m+=F*e;const p=Math.exp(-i*e);u*=p,d*=p,m*=p,u+=(2*Math.random()-1)*c*e,d+=(2*Math.random()-1)*c*e*.5,m+=(2*Math.random()-1)*c*e,o+=u*e,f+=d*e,s+=m*e,h-=e;const v=h>0&&Math.abs(o)<l&&Math.abs(f)<l&&Math.abs(s)<l?1:0;N[a+0]=o,N[a+1]=f,N[a+2]=s,N[a+3]=u,N[a+4]=d,N[a+5]=m,N[a+6]=h,N[a+10]=v;const g=N[a+9];N[a+9]=g*(.92+.25*r)*Math.max(.25,.15*h),N[a+8]=(A?24:9)*(.9+.8*r)}}(r);const n=parseFloat(G.value);(function(e,t,r){u.bindFramebuffer(u.FRAMEBUFFER,e),u.viewport(0,0,B,w),u.disable(u.BLEND),u.useProgram(m),te(m),u.activeTexture(u.TEXTURE0),u.bindTexture(u.TEXTURE_2D,t),u.uniform1i(u.getUniformLocation(m,"u_prev"),0),u.uniform1f(u.getUniformLocation(m,"u_decay"),r),u.drawArrays(u.TRIANGLE_STRIP,0,4),u.enable(u.BLEND),u.blendFunc(u.SRC_ALPHA,u.ONE),u.useProgram(h),function(){const e=u.getAttribLocation(h,"a_pos"),t=u.getAttribLocation(h,"a_size"),r=u.getAttribLocation(h,"a_brightness"),n=u.getAttribLocation(h,"a_type");u.bindBuffer(u.ARRAY_BUFFER,E),u.enableVertexAttribArray(e),u.vertexAttribPointer(e,3,u.FLOAT,!1,0,0),u.bindBuffer(u.ARRAY_BUFFER,_),u.enableVertexAttribArray(t),u.vertexAttribPointer(t,1,u.FLOAT,!1,0,0),u.bindBuffer(u.ARRAY_BUFFER,b),u.enableVertexAttribArray(r),u.vertexAttribPointer(r,1,u.FLOAT,!1,0,0),u.bindBuffer(u.ARRAY_BUFFER,F),u.enableVertexAttribArray(n),u.vertexAttribPointer(n,1,u.FLOAT,!1,0,0)}(),u.uniformMatrix4fv(u.getUniformLocation(h,"u_viewProj"),!1,Y());const n=function(){let e=0;for(let t=0;t<X;t++){const r=12*t;0!==N[r+10]&&(Q[3*e+0]=N[r+0],Q[3*e+1]=N[r+1],Q[3*e+2]=N[r+2],Z[e]=N[r+8],$[e]=N[r+9],ee[e]=N[r+7],e++)}return u.bindBuffer(u.ARRAY_BUFFER,E),u.bufferData(u.ARRAY_BUFFER,Q.subarray(0,3*e),u.DYNAMIC_DRAW),u.bindBuffer(u.ARRAY_BUFFER,_),u.bufferData(u.ARRAY_BUFFER,Z.subarray(0,e),u.DYNAMIC_DRAW),u.bindBuffer(u.ARRAY_BUFFER,b),u.bufferData(u.ARRAY_BUFFER,$.subarray(0,e),u.DYNAMIC_DRAW),u.bindBuffer(u.ARRAY_BUFFER,F),u.bufferData(u.ARRAY_BUFFER,ee.subarray(0,e),u.DYNAMIC_DRAW),e}();u.drawArrays(u.POINTS,0,n),u.bindFramebuffer(u.FRAMEBUFFER,null)})(T,M,n),function(e){u.disable(u.DEPTH_TEST),u.viewport(0,0,B,w),u.disable(u.BLEND),u.useProgram(d),te(d),u.activeTexture(u.TEXTURE0),u.bindTexture(u.TEXTURE_2D,e),u.uniform1i(u.getUniformLocation(d,"u_tex"),0),u.drawArrays(u.TRIANGLE_STRIP,0,4),u.useProgram(A);const t=u.getAttribLocation(A,"a_pos");u.bindBuffer(u.ARRAY_BUFFER,p),u.enableVertexAttribArray(t),u.vertexAttribPointer(t,3,u.FLOAT,!1,0,0),u.uniformMatrix4fv(u.getUniformLocation(A,"u_viewProj"),!1,Y()),u.uniform3f(u.getUniformLocation(A,"u_color"),.9,.95,1),u.drawArrays(u.LINES,0,24)}(g);let a=g;g=M,M=a;let o=T;T=y,y=o,requestAnimationFrame(e)});for(let e=0;e<48;e++){const e=l-2;O([(2*Math.random()-1)*e,(2*Math.random()-1)*e,(2*Math.random()-1)*e])}x()})();