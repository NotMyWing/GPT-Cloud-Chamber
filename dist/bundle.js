(()=>{"use strict";function e(e,t,r){const n=e.createShader(t);if(e.shaderSource(n,r),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS)){const t=e.getShaderInfoLog(n);throw e.deleteShader(n),new Error("Shader compile error: "+t+"\n"+r)}return n}function t(t,r,n,a={}){const o=e(t,t.VERTEX_SHADER,r),i=e(t,t.FRAGMENT_SHADER,n),u=t.createProgram();t.attachShader(u,o),t.attachShader(u,i);for(const[e,r]of Object.entries(a))t.bindAttribLocation(u,r,e);if(t.linkProgram(u),!t.getProgramParameter(u,t.LINK_STATUS)){const e=t.getProgramInfoLog(u);throw t.deleteProgram(u),new Error("Program link error: "+e)}return u}function r(e,t,r){const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,r,0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindTexture(e.TEXTURE_2D,null),n}function n(e,t){const r=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,r),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0);const n=e.checkFramebufferStatus(e.FRAMEBUFFER)===e.FRAMEBUFFER_COMPLETE;if(e.bindFramebuffer(e.FRAMEBUFFER,null),!n)throw new Error("Framebuffer incomplete");return r}const a="attribute vec2 a_pos;\nvarying vec2 v_uv;\nvoid main(){ v_uv = a_pos*0.5 + 0.5; gl_Position = vec4(a_pos,0.0,1.0); }\n",o="precision highp float;\nvarying float v_bright;\nvarying float v_type;\nvoid main(){\n  vec2 p = gl_PointCoord*2.0 - 1.0;\n  float r = length(p);\n  float disk = smoothstep(1.0, 0.6, r);\n  float core = mix(0.9, 1.3, v_type);\n  float glow = mix(0.6, 1.0, v_type);\n  vec3 col = vec3(1.0) * (v_bright*core);\n  float alpha = disk * glow;\n  gl_FragColor = vec4(col, alpha);\n}\n",i={perspective(e,t,r,n,a){const o=1/Math.tan(.5*t),i=1/(n-a);return e[0]=o/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(a+n)*i,e[11]=-1,e[12]=0,e[13]=0,e[14]=2*a*n*i,e[15]=0,e},lookAt(e,t,r,n){let a=t[0]-r[0],o=t[1]-r[1],i=t[2]-r[2],u=1/Math.hypot(a,o,i);a*=u,o*=u,i*=u;let l=n[1]*i-n[2]*o,f=n[2]*a-n[0]*i,c=n[0]*o-n[1]*a;u=1/Math.hypot(l,f,c),l*=u,f*=u,c*=u;let s=o*c-i*f,d=i*l-a*c,_=a*f-o*l;return e[0]=l,e[1]=s,e[2]=a,e[3]=0,e[4]=f,e[5]=d,e[6]=o,e[7]=0,e[8]=c,e[9]=_,e[10]=i,e[11]=0,e[12]=-(l*t[0]+f*t[1]+c*t[2]),e[13]=-(s*t[0]+d*t[1]+_*t[2]),e[14]=-(a*t[0]+o*t[1]+i*t[2]),e[15]=1,e},multiply(e,t,r){const n=t[0],a=t[1],o=t[2],i=t[3],u=t[4],l=t[5],f=t[6],c=t[7],s=t[8],d=t[9],_=t[10],E=t[11],R=t[12],m=t[13],F=t[14],A=t[15],b=r[0],h=r[1],v=r[2],g=r[3],T=r[4],p=r[5],M=r[6],B=r[7],w=r[8],y=r[9],U=r[10],L=r[11],P=r[12],x=r[13],D=r[14],I=r[15];return e[0]=n*b+u*h+s*v+R*g,e[1]=a*b+l*h+d*v+m*g,e[2]=o*b+f*h+_*v+F*g,e[3]=i*b+c*h+E*v+A*g,e[4]=n*T+u*p+s*M+R*B,e[5]=a*T+l*p+d*M+m*B,e[6]=o*T+f*p+_*M+F*B,e[7]=i*T+c*p+E*M+A*B,e[8]=n*w+u*y+s*U+R*L,e[9]=a*w+l*y+d*U+m*L,e[10]=o*w+f*y+_*U+F*L,e[11]=i*w+c*y+E*U+A*L,e[12]=n*P+u*x+s*D+R*I,e[13]=a*P+l*x+d*D+m*I,e[14]=o*P+f*x+_*D+F*I,e[15]=i*P+c*x+E*D+A*I,e}},u=5e3,l=1/30,f=20,c=256,s=document.createElement("canvas");document.getElementById("app").appendChild(s);const d=function(e){const t=e.getContext("webgl",{alpha:!1,antialias:!0,preserveDrawingBuffer:!1});if(!t)throw new Error("WebGL not supported");return t}(s),_=t(d,a,"precision highp float;\nvarying vec2 v_uv;\nuniform sampler2D u_tex;\nvoid main(){ gl_FragColor = texture2D(u_tex, v_uv); }\n"),E=t(d,a,"precision highp float;\nvarying vec2 v_uv;\nuniform sampler2D u_prev;\nuniform float u_decay;\nvoid main(){\n  vec4 col = texture2D(u_prev, v_uv);\n  gl_FragColor = vec4(col.rgb * u_decay, 1.0);\n}\n"),R=t(d,"precision highp float;\nattribute vec3 a_pos;\nattribute float a_size;\nattribute float a_brightness;\nattribute float a_type; // 0=beta,1=alpha\nuniform mat4 u_viewProj;\nvarying float v_bright;\nvarying float v_type;\nvoid main(){\n  v_bright = a_brightness;\n  v_type = a_type;\n  vec4 clip = u_viewProj * vec4(a_pos, 1.0);\n  gl_Position = clip;\n  float size = a_size / max(0.1, clip.w);\n  gl_PointSize = size;\n}\n",o),m=t(d,"precision highp float;\nattribute vec3 a_pos;\nattribute float a_size;\nattribute float a_brightness;\nattribute float a_type;\nuniform float u_bounds;\nvarying float v_bright;\nvarying float v_type;\nvoid main(){\n  v_bright = a_brightness;\n  v_type = a_type;\n  gl_Position = vec4(a_pos.x/u_bounds, a_pos.z/u_bounds, 0.0, 1.0);\n  gl_PointSize = a_size;\n}\n",o),F=t(d,"attribute vec3 a_pos;\nuniform mat4 u_viewProj;\nvoid main(){ gl_Position = u_viewProj * vec4(a_pos, 1.0); }\n","precision highp float;\nuniform vec3 u_color;\nvoid main(){ gl_FragColor = vec4(u_color, 1.0); }\n"),A=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,A),d.bufferData(d.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),d.STATIC_DRAW);const b=d.createBuffer(),h=d.createBuffer(),v=d.createBuffer(),g=d.createBuffer(),T=d.createBuffer(),p=[[-f,-f,-f],[f,-f,-f],[f,-f,-f],[f,-f,f],[f,-f,f],[-f,-f,f],[-f,-f,f],[-f,-f,-f],[-f,f,-f],[f,f,-f],[f,f,-f],[f,f,f],[f,f,f],[-f,f,f],[-f,f,f],[-f,f,-f],[-f,-f,-f],[-f,f,-f],[f,-f,-f],[f,f,-f],[f,-f,f],[f,f,f],[-f,-f,f],[-f,f,f]].flat();d.bindBuffer(d.ARRAY_BUFFER,T),d.bufferData(d.ARRAY_BUFFER,new Float32Array(p),d.STATIC_DRAW);let M,B,w,y,U,L,P,x,D=2,I=2;function S(){d.disable(d.BLEND),d.bindFramebuffer(d.FRAMEBUFFER,w),d.clearColor(0,0,0,1),d.clear(d.COLOR_BUFFER_BIT),d.bindFramebuffer(d.FRAMEBUFFER,y),d.clearColor(0,0,0,1),d.clear(d.COLOR_BUFFER_BIT),P&&C(),d.bindFramebuffer(d.FRAMEBUFFER,null)}function C(){d.disable(d.BLEND),d.bindFramebuffer(d.FRAMEBUFFER,P),d.clearColor(0,0,0,1),d.clear(d.COLOR_BUFFER_BIT),d.bindFramebuffer(d.FRAMEBUFFER,x),d.clearColor(0,0,0,1),d.clear(d.COLOR_BUFFER_BIT),d.bindFramebuffer(d.FRAMEBUFFER,null)}function N(){const e=Math.min(2,window.devicePixelRatio||1),t=Math.max(2,Math.floor(window.innerWidth*e)),a=Math.max(2,Math.floor(window.innerHeight*e));t===D&&a===I||(D=t,I=a,s.width=t,s.height=a,s.style.width="100%",s.style.height="100%",d.viewport(0,0,t,a),function(e,t){M&&d.deleteTexture(M),B&&d.deleteTexture(B),w&&d.deleteFramebuffer(w),y&&d.deleteFramebuffer(y),M=r(d,e,t),B=r(d,e,t),w=n(d,M),y=n(d,B),S()}(t,a))}window.addEventListener("resize",N),N(),U&&d.deleteTexture(U),L&&d.deleteTexture(L),P&&d.deleteFramebuffer(P),x&&d.deleteFramebuffer(x),U=r(d,c,c),L=r(d,c,c),P=n(d,U),x=n(d,L),C();let Y=.6,O=.2,X=14,W=!1,k=0,G=0;function z(){const e=[X*Math.cos(O)*Math.cos(Y),X*Math.sin(O),X*Math.cos(O)*Math.sin(Y)],t=new Float32Array(16),r=new Float32Array(16),n=new Float32Array(16);i.lookAt(t,e,[0,0,0],[0,1,0]);const a=60*Math.PI/180;return i.perspective(r,a,D/I,.1,400),i.multiply(n,r,t),n}s.addEventListener("mousedown",e=>{W=!0,k=e.clientX,G=e.clientY}),window.addEventListener("mouseup",()=>W=!1),window.addEventListener("mousemove",e=>{if(!W)return;const t=(e.clientX-k)/window.innerWidth,r=(e.clientY-G)/window.innerHeight;Y+=3*t,O=Math.max(-1.2,Math.min(1.2,O+3*r)),k=e.clientX,G=e.clientY}),window.addEventListener("wheel",e=>{X=Math.max(4,Math.min(40,X+Math.sign(e.deltaY)))});const H=new Float32Array(6e4);let j=0;function V(e){const t=10+(10*Math.random()|0);for(let r=0;r<t;r++){const t=Math.random()<.25,r=t?2:6,n=t?3:6,a=t?24:9,o=t?.9:.55,i=q();K(e[0],e[1],e[2],i[0]*r,i[1]*r,i[2]*r,n,t?1:0,a,o)}}function q(){const e=2*Math.random()-1,t=Math.random()*Math.PI*2,r=Math.sqrt(Math.max(0,1-e*e));return[r*Math.cos(t),r*Math.sin(t),e]}function K(e,t,r,n,a,o,i,l,f,c){let s=-1;for(let e=0;e<j;e++)if(0===H[12*e+10]){s=e;break}if(s<0){if(j>=u)return;s=j++}const d=12*s;H[d+0]=e,H[d+1]=t,H[d+2]=r,H[d+3]=n,H[d+4]=a,H[d+5]=o,H[d+6]=i,H[d+7]=l,H[d+8]=f,H[d+9]=c,H[d+10]=1}s.addEventListener("click",e=>{V(function(e,t){const r=Y,n=O,a=X,o=[a*Math.cos(n)*Math.cos(r),a*Math.sin(n),a*Math.cos(n)*Math.sin(r)],i=e/window.innerWidth*2-1,u=1-t/window.innerHeight*2,l=[-o[0],-o[1],-o[2]],f=Math.hypot(l[0],l[1],l[2]);l[0]/=f,l[1]/=f,l[2]/=f;let c=[l[2],0,-l[0]],s=Math.hypot(c[0],c[1],c[2]);c=[c[0]/s,c[1]/s,c[2]/s];let d=[c[1]*l[2]-c[2]*l[1],c[2]*l[0]-c[0]*l[2],c[0]*l[1]-c[1]*l[0]];const _=60*Math.PI/180,E=window.innerWidth/window.innerHeight,R=Math.tan(_/2),m=[l[0]+i*E*R*c[0]+u*R*d[0],l[1]+i*E*R*c[1]+u*R*d[1],l[2]+i*E*R*c[2]+u*R*d[2]],F=-o[1]/(m[1]||1e-6);return[o[0]+m[0]*F,0,o[2]+m[2]*F]}(e.clientX,e.clientY))});const J=document.getElementById("bRange"),Q=document.getElementById("vRange"),Z=document.getElementById("rRange"),$=document.getElementById("trailRange"),ee=document.getElementById("toggleBtn"),te=document.getElementById("clearBtn"),re=document.getElementById("densityBtn");let ne=!1;ee.addEventListener("click",()=>{ne=!ne,ee.textContent=ne?"Resume":"Pause"}),te.addEventListener("click",()=>{S()}),re.addEventListener("click",()=>{ae=!ae,re.textContent=ae?"Density: On":"Density: Off",ae&&C()});let ae=!1,oe=new Float32Array(15e3),ie=new Float32Array(u),ue=new Float32Array(u),le=new Float32Array(u);function fe(e){const t=d.getAttribLocation(e,"a_pos");d.bindBuffer(d.ARRAY_BUFFER,A),d.enableVertexAttribArray(t),d.vertexAttribPointer(t,2,d.FLOAT,!1,0,0)}function ce(){const e=d.getAttribLocation(R,"a_pos"),t=d.getAttribLocation(R,"a_size"),r=d.getAttribLocation(R,"a_brightness"),n=d.getAttribLocation(R,"a_type");d.bindBuffer(d.ARRAY_BUFFER,b),d.enableVertexAttribArray(e),d.vertexAttribPointer(e,3,d.FLOAT,!1,0,0),d.bindBuffer(d.ARRAY_BUFFER,h),d.enableVertexAttribArray(t),d.vertexAttribPointer(t,1,d.FLOAT,!1,0,0),d.bindBuffer(d.ARRAY_BUFFER,v),d.enableVertexAttribArray(r),d.vertexAttribPointer(r,1,d.FLOAT,!1,0,0),d.bindBuffer(d.ARRAY_BUFFER,g),d.enableVertexAttribArray(n),d.vertexAttribPointer(n,1,d.FLOAT,!1,0,0)}function se(){let e=0;for(let t=0;t<j;t++){const r=12*t;0!==H[r+10]&&(oe[3*e+0]=H[r+0],oe[3*e+1]=H[r+1],oe[3*e+2]=H[r+2],ie[e]=H[r+8],ue[e]=H[r+9],le[e]=H[r+7],e++)}return d.bindBuffer(d.ARRAY_BUFFER,b),d.bufferData(d.ARRAY_BUFFER,oe.subarray(0,3*e),d.DYNAMIC_DRAW),d.bindBuffer(d.ARRAY_BUFFER,h),d.bufferData(d.ARRAY_BUFFER,ie.subarray(0,e),d.DYNAMIC_DRAW),d.bindBuffer(d.ARRAY_BUFFER,v),d.bufferData(d.ARRAY_BUFFER,ue.subarray(0,e),d.DYNAMIC_DRAW),d.bindBuffer(d.ARRAY_BUFFER,g),d.bufferData(d.ARRAY_BUFFER,le.subarray(0,e),d.DYNAMIC_DRAW),e}let de=performance.now();requestAnimationFrame(function e(t){const r=Math.min(l,(t-de)/1e3);de=t,ne||function(e){parseFloat(J.value);const t=parseFloat(Q.value),r=200*parseFloat(Z.value)*e;let n=Math.floor(r);Math.random()<r-n&&n++;for(let e=0;e<n;e++){const e=18;V([(2*Math.random()-1)*e,(2*Math.random()-1)*e,(2*Math.random()-1)*e])}const a=.3+.8*t,o=.3+1.2*t;for(let r=0;r<j;r++){const n=12*r;if(0===H[n+10])continue;let i=H[n+0],u=H[n+1],l=H[n+2],c=H[n+3],s=H[n+4],d=H[n+5],_=H[n+6];const E=H[n+7],R=E?.6:1,m=[0,parseFloat(J.value),0],F=R*(s*m[2]-d*m[1]),A=R*(d*m[0]-c*m[2]),b=R*(c*m[1]-s*m[0]);c+=F*e,s+=A*e,d+=b*e;const h=Math.exp(-a*e);c*=h,s*=h,d*=h,c+=(2*Math.random()-1)*o*e,s+=(2*Math.random()-1)*o*e*.5,d+=(2*Math.random()-1)*o*e,i+=c*e,u+=s*e,l+=d*e,_-=e;const v=_>0&&Math.abs(i)<f&&Math.abs(u)<f&&Math.abs(l)<f?1:0;H[n+0]=i,H[n+1]=u,H[n+2]=l,H[n+3]=c,H[n+4]=s,H[n+5]=d,H[n+6]=_,H[n+10]=v;const g=H[n+9];H[n+9]=g*(.92+.25*t)*Math.max(.25,.15*_),H[n+8]=(E?24:9)*(.9+.8*t)}}(r);const n=parseFloat($.value);!function(e,t,r){d.bindFramebuffer(d.FRAMEBUFFER,e),d.viewport(0,0,D,I),d.disable(d.BLEND),d.useProgram(E),fe(E),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,t),d.uniform1i(d.getUniformLocation(E,"u_prev"),0),d.uniform1f(d.getUniformLocation(E,"u_decay"),r),d.drawArrays(d.TRIANGLE_STRIP,0,4),d.enable(d.BLEND),d.blendFunc(d.SRC_ALPHA,d.ONE),d.useProgram(R),ce(),d.uniformMatrix4fv(d.getUniformLocation(R,"u_viewProj"),!1,z());const n=se();d.drawArrays(d.POINTS,0,n),d.bindFramebuffer(d.FRAMEBUFFER,null)}(w,B,n),ae&&function(e,t,r){d.bindFramebuffer(d.FRAMEBUFFER,e),d.viewport(0,0,c,c),d.disable(d.BLEND),d.useProgram(E),fe(E),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,t),d.uniform1i(d.getUniformLocation(E,"u_prev"),0),d.uniform1f(d.getUniformLocation(E,"u_decay"),r),d.drawArrays(d.TRIANGLE_STRIP,0,4),d.enable(d.BLEND),d.blendFunc(d.SRC_ALPHA,d.ONE),d.useProgram(m),ce(),d.uniform1f(d.getUniformLocation(m,"u_bounds"),f);const n=se();d.drawArrays(d.POINTS,0,n),d.bindFramebuffer(d.FRAMEBUFFER,null)}(P,L,n),function(e){d.disable(d.DEPTH_TEST),d.viewport(0,0,D,I),d.disable(d.BLEND),d.useProgram(_),fe(_),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,e),d.uniform1i(d.getUniformLocation(_,"u_tex"),0),d.drawArrays(d.TRIANGLE_STRIP,0,4),d.useProgram(F);const t=d.getAttribLocation(F,"a_pos");if(d.bindBuffer(d.ARRAY_BUFFER,T),d.enableVertexAttribArray(t),d.vertexAttribPointer(t,3,d.FLOAT,!1,0,0),d.uniformMatrix4fv(d.getUniformLocation(F,"u_viewProj"),!1,z()),d.uniform3f(d.getUniformLocation(F,"u_color"),.9,.95,1),d.drawArrays(d.LINES,0,24),ae){const e=Math.floor(.3*Math.min(D,I));d.viewport(10,10,e,e),d.disable(d.BLEND),d.useProgram(_),fe(_),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,U),d.uniform1i(d.getUniformLocation(_,"u_tex"),0),d.drawArrays(d.TRIANGLE_STRIP,0,4),d.viewport(0,0,D,I)}}(M);let a=M;M=B,B=a;let o=w;w=y,y=o,ae&&(a=U,U=L,L=a,o=P,P=x,x=o),requestAnimationFrame(e)});for(let e=0;e<48;e++){const e=f-2;V([(2*Math.random()-1)*e,(2*Math.random()-1)*e,(2*Math.random()-1)*e])}S()})();